name: Auto Documentation

on:
  push:
    branches: [ develop, main, "feature/**" ]
    paths:
      - 'lib/**'
      - 'supabase/**'
      - 'docs/**'

jobs:
  update-docs:
    name: Update Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Generate code statistics
        id: stats
        run: |
          echo "dart_files=$(find lib -name '*.dart' | wc -l)" >> $GITHUB_OUTPUT
          echo "lines_of_code=$(find lib -name '*.dart' -exec cat {} \; | wc -l)" >> $GITHUB_OUTPUT
          echo "test_files=$(find test -name '*_test.dart' 2>/dev/null | wc -l || echo 0)" >> $GITHUB_OUTPUT

      - name: Update PROJECT_PLAN.md
        run: |
          # ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ë‚ ì§œ ê°±ì‹ 
          sed -i "s/\*\*ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸\*\*: .*/\*\*ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸\*\*: $(date +%Y-%m-%d)/" PROJECT_PLAN.md

      - name: Generate daily log
        run: |
          DATE=$(date +%Y-%m-%d)
          LOG_FILE="docs/logs/daily_${DATE}.md"
          mkdir -p docs/logs

          cat > "$LOG_FILE" << EOF
          # Daily Log - ${DATE}

          ## ğŸ“Š í†µê³„
          - Dart íŒŒì¼ ìˆ˜: ${{ steps.stats.outputs.dart_files }}
          - ì½”ë“œ ë¼ì¸ ìˆ˜: ${{ steps.stats.outputs.lines_of_code }}
          - í…ŒìŠ¤íŠ¸ íŒŒì¼ ìˆ˜: ${{ steps.stats.outputs.test_files }}

          ## ğŸ“ ë³€ê²½ ì‚¬í•­
          $(git log --since="yesterday" --pretty=format:"- %s (%an)" --no-merges)

          ## ğŸ”œ ë‹¤ìŒ ì‘ì—…
          <!-- Phase ê³„íš ì°¸ì¡° -->
          EOF

      - name: Commit documentation changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add PROJECT_PLAN.md docs/

          if git diff --staged --quiet; then
            echo "No documentation changes to commit"
          else
            git commit -m "docs: ìë™ ë¬¸ì„œ ì—…ë°ì´íŠ¸ [skip ci]"
            git push
          fi
