# ì¶”ì²œì¸ ì½”ë“œ ì‹œìŠ¤í…œ ì„¤ê³„

> **ëª©í‘œ**: ê°™ì€ í•™êµ ì†Œì† êµì‚¬ë§Œ ì´ˆëŒ€í•  ìˆ˜ ìˆëŠ” ê°„ë‹¨í•˜ê³  ì•ˆì „í•œ ì¶”ì²œ ì‹œìŠ¤í…œ

---

## ğŸ¯ í•µì‹¬ ì›ì¹™

### âœ… ì±„íƒí•œ ê¸°ëŠ¥
- **ê°™ì€ í•™êµ ì œì•½**: ì¶”ì²œì¸ê³¼ í”¼ì¶”ì²œì¸ì´ ë™ì¼í•œ í•™êµì—¬ì•¼ í•¨
- **ì½”ë“œ ìƒì„±**: ìŠ¹ì¸ëœ êµì‚¬ëŠ” ìì‹ ì˜ í•™êµìš© ì´ˆëŒ€ ì½”ë“œ ìƒì„± ê°€ëŠ¥
- **ì‚¬ìš© íšŸìˆ˜ ì œí•œ**: ê° ì½”ë“œëŠ” 5íšŒê¹Œì§€ë§Œ ì‚¬ìš© ê°€ëŠ¥
- **ë§Œë£Œ ê¸°ê°„**: ìƒì„± í›„ 30ì¼ í›„ ìë™ ë§Œë£Œ

### âŒ ì œê±°ëœ ë³µì¡í•œ ê¸°ëŠ¥
- ~~ì‹ ë¢° ì ìˆ˜ ìƒì†~~
- ~~ì—°ëŒ€ ì±…ì„~~
- ~~Fast Track ìŠ¹ì¸~~

---

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### 1. `referral_codes` (ì¶”ì²œ ì½”ë“œ)

```sql
CREATE TABLE referral_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- 6ìë¦¬ ëœë¤ ì½”ë“œ (ì˜ˆ: "SEOUL-ABC123")
  code TEXT NOT NULL UNIQUE,

  -- ìƒì„±ì ì •ë³´
  created_by UUID NOT NULL REFERENCES users(id),
  school_name TEXT NOT NULL, -- ê²€ì¦ìš© (ìƒì„±ìì˜ í•™êµ)

  -- ì‚¬ìš© ì œí•œ
  max_uses INT DEFAULT 5,
  current_uses INT DEFAULT 0,
  expires_at TIMESTAMPTZ DEFAULT (NOW() + INTERVAL '30 days'),

  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 2. `referral_usage` (ì‚¬ìš© ì´ë ¥)

```sql
CREATE TABLE referral_usage (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  referral_code_id UUID NOT NULL REFERENCES referral_codes(id),
  used_by UUID NOT NULL REFERENCES users(id),

  used_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## ğŸ”„ ì›Œí¬í”Œë¡œìš°

### 1. ì¶”ì²œ ì½”ë“œ ìƒì„±

**ì¡°ê±´**:
- ì‚¬ìš©ìê°€ `verification_status = 'approved'` (ìŠ¹ì¸ëœ êµì‚¬)
- ìµœëŒ€ 3ê°œì˜ í™œì„± ì½”ë“œë§Œ ë³´ìœ  ê°€ëŠ¥

**í”„ë¡œì„¸ìŠ¤**:
```dart
// 1. ì‚¬ìš©ì ì •ë³´ í™•ì¸
final user = await supabase.auth.getUser();
final userData = await supabase
  .from('users')
  .select()
  .eq('id', user.id)
  .single();

// 2. 6ìë¦¬ ëœë¤ ì½”ë“œ ìƒì„±
final code = generateReferralCode(userData['school_name']);
// ì˜ˆ: "SEOUL-AB3C9F"

// 3. ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
await supabase.from('referral_codes').insert({
  'code': code,
  'created_by': user.id,
  'school_name': userData['school_name'],
  'max_uses': 5,
  'expires_at': DateTime.now().add(Duration(days: 30)),
});
```

### 2. ì¶”ì²œ ì½”ë“œë¡œ ê°€ì…

**ì¡°ê±´**:
- í”¼ì¶”ì²œì¸ì˜ `school_name`ì´ ì½”ë“œ ìƒì„±ìì˜ `school_name`ê³¼ ì¼ì¹˜
- ì½”ë“œê°€ ìœ íš¨ (ë§Œë£Œ ì•ˆ ë¨, ì‚¬ìš© íšŸìˆ˜ ë‚¨ìŒ)

**í”„ë¡œì„¸ìŠ¤**:
```dart
// 1. ì½”ë“œ ê²€ì¦
final referralCode = await supabase
  .from('referral_codes')
  .select()
  .eq('code', enteredCode)
  .eq('is_active', true)
  .lt('current_uses', 'max_uses')
  .gt('expires_at', DateTime.now().toIso8601String())
  .single();

// 2. í•™êµëª… ì¼ì¹˜ í™•ì¸
if (referralCode['school_name'] != userData['school_name']) {
  throw Exception('ì´ ì½”ë“œëŠ” ${referralCode['school_name']} ì†Œì†ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
}

// 3. ì‚¬ìš©ì ê°€ì… ì²˜ë¦¬
await supabase.from('users').insert({
  'name': name,
  'school_name': schoolName,
  'verification_status': 'pending', // ì—¬ì „íˆ ê´€ë¦¬ì ìŠ¹ì¸ í•„ìš”
});

// 4. ì‚¬ìš© ì´ë ¥ ê¸°ë¡
await supabase.from('referral_usage').insert({
  'referral_code_id': referralCode['id'],
  'used_by': newUser.id,
});

// 5. ì‚¬ìš© íšŸìˆ˜ ì¦ê°€
await supabase.rpc('increment_referral_uses', {
  'code_id': referralCode['id']
});
```

---

## ğŸ¨ UI/UX í”Œë¡œìš°

### ì½”ë“œ ìƒì„± í™”ë©´

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ë‚´ ì¶”ì²œ ì½”ë“œ                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  SEOUL-AB3C9F             â”‚  â”‚
â”‚  â”‚  ì‚¬ìš©: 2 / 5              â”‚  â”‚
â”‚  â”‚  ë§Œë£Œ: 2026-02-03         â”‚  â”‚
â”‚  â”‚  [ê³µìœ í•˜ê¸°]               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  + ìƒˆ ì½”ë“œ ìƒì„±            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì½”ë“œ ì…ë ¥ í™”ë©´ (íšŒì›ê°€ì… ì‹œ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  íšŒì›ê°€ì…                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  ì´ë¦„: [ê¹€ì² ìˆ˜              ]   â”‚
â”‚  í•™êµ: [ì„œìš¸ì´ˆë“±í•™êµ        ]   â”‚
â”‚                                 â”‚
â”‚  â”Œ ì¶”ì²œ ì½”ë“œ (ì„ íƒ)           â” â”‚
â”‚  â”‚ [SEOUL-______]             â”‚ â”‚
â”‚  â”‚ ê°™ì€ í•™êµ ì„ ìƒë‹˜ì˜ ì½”ë“œ    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  ë˜ëŠ”                           â”‚
â”‚                                 â”‚
â”‚  [ì¬ì§ì¦ëª…ì„œë¡œ ê°€ì…í•˜ê¸°]         â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ›¡ï¸ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### 1. í•™êµëª… ê²€ì¦

**ë¬¸ì œì **: ì‚¬ìš©ìê°€ ì„ì˜ë¡œ í•™êµëª…ì„ ì…ë ¥í•  ìˆ˜ ìˆìŒ

**í•´ê²°ì±…**:
- ë°ì´í„°ë² ì´ìŠ¤ì— "í•™êµ ë§ˆìŠ¤í„°" í…Œì´ë¸” ìƒì„±
- í–‰ì •ì•ˆì „ë¶€ ê³µê°œ ë°ì´í„° í™œìš© (ì „êµ­ ì´ˆì¤‘ê³  ëª©ë¡)
- ë“œë¡­ë‹¤ìš´ ì„ íƒ ë°©ì‹ìœ¼ë¡œ ì œí•œ

```sql
CREATE TABLE schools (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL UNIQUE,
  education_office TEXT REFERENCES education_offices(code),
  address TEXT,
  school_type TEXT CHECK (school_type IN ('ì´ˆ', 'ì¤‘', 'ê³ ', 'ê¸°íƒ€'))
);
```

### 2. ì½”ë“œ ë¬´ì‘ìœ„ ëŒ€ì… ê³µê²© ë°©ì§€

**ëŒ€ì±…**:
- ì½”ë“œ í˜•ì‹: `{ì§€ì—­}-{6ìë¦¬}` (ì˜ˆ: `SEOUL-A3B9F2`)
- í•™êµëª… prefixë¡œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¶„ë¦¬
- ì‹¤íŒ¨ ì‹œ Rate Limiting (5íšŒ ì‹¤íŒ¨ ì‹œ 5ë¶„ ì°¨ë‹¨)

### 3. ì¤‘ë³µ ì‚¬ìš© ë°©ì§€

**ëŒ€ì±…**:
```sql
-- ë™ì¼ ì‚¬ìš©ìê°€ ì—¬ëŸ¬ ì½”ë“œë¡œ ê°€ì… ì‹œë„ ë°©ì§€
CREATE UNIQUE INDEX idx_one_referral_per_user
ON referral_usage(used_by);
```

---

## ğŸ“Š ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ

### ì¶”ì²œ ì½”ë“œ í†µê³„

ê´€ë¦¬ìëŠ” ë‹¤ìŒ ì •ë³´ë¥¼ í™•ì¸ ê°€ëŠ¥:
- í•™êµë³„ ì¶”ì²œ í™œì„±ë„
- ê°€ì¥ ë§ì´ ì‚¬ìš©ëœ ì½”ë“œ Top 10
- ë§Œë£Œ ì„ë°• ì½”ë“œ ì•Œë¦¼

```sql
-- í•™êµë³„ ì¶”ì²œ í†µê³„
SELECT
  r.school_name,
  COUNT(DISTINCT r.id) as total_codes,
  SUM(r.current_uses) as total_invites
FROM referral_codes r
WHERE r.is_active = true
GROUP BY r.school_name
ORDER BY total_invites DESC;
```

---

## ğŸš€ êµ¬í˜„ ìš°ì„ ìˆœìœ„

### Phase 2 (ì¸ì¦ ì‹œìŠ¤í…œ)
- [ ] `referral_codes`, `referral_usage` í…Œì´ë¸” ìƒì„±
- [ ] ì½”ë“œ ìƒì„± API
- [ ] ì½”ë“œ ê²€ì¦ ë¡œì§

### Phase 3 (UI)
- [ ] ë‚´ ì¶”ì²œ ì½”ë“œ í™”ë©´
- [ ] ê°€ì… ì‹œ ì½”ë“œ ì…ë ¥ í•„ë“œ
- [ ] ê³µìœ í•˜ê¸° ê¸°ëŠ¥ (í´ë¦½ë³´ë“œ ë³µì‚¬)

---

## ğŸ”„ ëŒ€ì•ˆ: QR ì½”ë“œ

í–¥í›„ í™•ì¥ ê°€ëŠ¥:
- ì¶”ì²œ ì½”ë“œë¥¼ QR ì½”ë“œë¡œ ë³€í™˜
- ëª¨ë°”ì¼ì—ì„œ ì¹´ë©”ë¼ë¡œ ìŠ¤ìº”

```dart
// QR ì½”ë“œ ìƒì„± ì˜ˆì‹œ
final qrData = 'uncany://referral?code=SEOUL-AB3C9F';
```

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] ìŠ¤í‚¤ë§ˆ ì„¤ê³„ ì™„ë£Œ
- [x] ê°™ì€ í•™êµ ì œì•½ ì¡°ê±´ ëª…ì‹œ
- [ ] í•™êµ ë§ˆìŠ¤í„° ë°ì´í„° í™•ë³´
- [ ] ì½”ë“œ ìƒì„± ì•Œê³ ë¦¬ì¦˜ êµ¬í˜„
- [ ] ê²€ì¦ ë¡œì§ êµ¬í˜„
- [ ] UI êµ¬í˜„

---

**ì—…ë°ì´íŠ¸**: 2026-01-04
**ë‹¤ìŒ ë‹¨ê³„**: í•™êµ ë§ˆìŠ¤í„° ë°ì´í„° ìˆ˜ì§‘ ë° ì •ê·œí™”
